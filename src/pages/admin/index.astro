---
import "@/styles/global.css"; // Importa estils globals
import ButtonForm from "@/components/buttonForm.astro"; // Importa un component de botó reutilitzable
const { cookies, redirect } = Astro;

// Agafa les cookies d'autenticació
const accessToken = cookies.get("sb-access-token");
const refreshToken = cookies.get("sb-refresh-token");

// Si hi ha accessToken i refreshToken, redirigeix al dashboard
if (accessToken && refreshToken) {
  return redirect("/admin/dashboard");
}
---

<!doctype html>
<html lang="ca">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="generator" content={Astro.generator} />
    <title>Accés al Panell Admin</title>
  </head>
  <body>
    <main>
      <!-- Secció del títol -->
      <section class="flex flex-col items-center justify-center mt-12">
        <div class="text-center space-y-4">
          <h1 class="text-2xl md:text-4xl font-bold">Pau Segués Vitutia Web</h1>
          <h2 class="text-xl md:text-2xl">Accés al Panell Admin</h2>
        </div>
      </section>

      <!-- Formulari de login -->
      <div class="flex items-center justify-center mt-24 px-4">
        <form
          id="loginForm"
          novalidate
          class="w-full max-w-sm md:max-w-md bg-web-dark-blue/95 backdrop-blur-md shadow-2xl rounded-2xl p-8 space-y-6 border border-white/10"
        >
          <!-- Títol del formulari -->
          <h2 class="text-2xl font-semibold text-center text-white mb-2">
            Inicia Sessió
          </h2>

          <!-- Input d'email -->
          <div class="flex flex-col space-y-1">
            <label for="email" class="text-white text-sm font-medium">Email</label>
            <input
              type="email"
              name="email"
              id="email"
              required
              placeholder="correu@exemple.com"
              class="p-3 rounded-lg bg-web-pearl-blue text-web-night-blue placeholder:text-web-night-blue/60 focus:outline-none focus:ring-2 focus:ring-web-night-blue transition"
            />
          </div>

          <!-- Input de contrasenya -->
          <div class="flex flex-col space-y-1">
            <label for="password" class="text-white text-sm font-medium">Contrasenya</label>
            <input
              type="password"
              name="password"
              id="password"
              required
              placeholder="••••••••"
              class="p-3 rounded-lg bg-web-pearl-blue text-web-night-blue placeholder:text-web-night-blue/60 focus:outline-none focus:ring-2 focus:ring-web-night-blue transition"
            />
          </div>

          <!-- Missatge d'error -->
          <div id="errorMessage" class="text-red-400 text-sm text-center min-h-6"></div>

          <!-- Botó d'enviament -->
          <div class="flex items-center justify-center">
            <ButtonForm Text="Inicia Sessió" />
          </div>

        </form>
      </div>

    </main>

    <!-- Script per gestionar el login amb fetch -->
    <script type="module">
      const form = document.getElementById('loginForm');
      const errorMessage = document.getElementById('errorMessage');

      form.addEventListener('submit', async (e) => {
        e.preventDefault(); // Evita que el formulari recarregui la pàgina
        errorMessage.textContent = ''; // Neteja missatges d'error

        const formData = new FormData(form); // Agafa les dades del formulari
        const res = await fetch('/api/auth/signin', { // Crida al endpoint d'autenticació
          method: 'POST',
          body: formData
        });

        const data = await res.json();

        if (!res.ok) {
          // Mostra error si la resposta no és correcta
          errorMessage.textContent = data.error || 'S\'ha produït un error desconegut';
        } else {
          // Redirecciona al dashboard si l'autenticació és correcta
          window.location.href = '/admin/dashboard';
        }
      });
    </script>
  </body>
</html>
