---
import LayoutAdmin from "@/layouts/LayoutAdmin.astro";
import ButtonForm from "@/components/buttons/buttonForm.astro";
import { createSupabase } from "@/lib/supabase";

const { table, id } = Astro.params as { table: string; id: string };

const accessToken = Astro.cookies.get("sb-access-token")?.value;
const refreshToken = Astro.cookies.get("sb-refresh-token")?.value;

if (!accessToken || !refreshToken) {
  return Astro.redirect("/admin");
}

let session;
try {
  const supabase = createSupabase();
  const { data, error } = await supabase.auth.setSession({
    access_token: accessToken,
    refresh_token: refreshToken,
  });

  if (error) {
    Astro.cookies.delete("sb-access-token", { path: "/" });
    Astro.cookies.delete("sb-refresh-token", { path: "/" });
    return Astro.redirect("/admin");
  }

  session = data.session;
} catch {
  Astro.cookies.delete("sb-access-token", { path: "/" });
  Astro.cookies.delete("sb-refresh-token", { path: "/" });
  return Astro.redirect("/admin");
}

// Generaci√≥ autom√†tica de camps del formulari
import { dbTables } from "@/consts/dbTables";
const tableFields = dbTables.find((t) => t.name === table)?.fields;

// üîç Obtenir dades actuals del registre
let item = null;
try {
  const supabase = createSupabase();
  const { data, error } = await supabase
    .from(table)
    .select("*")
    .eq("id", id)
    .single();

  if (error || !data) {
    return Astro.redirect(`/admin/${table}`);
  }

  item = data;
} catch {
  return Astro.redirect(`/admin/${table}`);
}

// üìù Gesti√≥ del POST (actualitzar entrada)
if (Astro.request.method === "POST") {
  try {
    const formData = await Astro.request.formData();
    const newData = Object.fromEntries(formData.entries());
    const imageFile = formData.get("image") as File | null;

    if (imageFile && imageFile.size > 0) {
      // üî• 1Ô∏è‚É£ Eliminar la imatge antiga (si existeix)
      if (item.image) {
        try {
          const oldFileName = item.image.split("/").pop();
          if (oldFileName) {
            const supabase = createSupabase();
            await supabase.storage.from("images").remove([oldFileName]);
          }
        } catch {}
      }

      // üì§ 2Ô∏è‚É£ Pujar la nova imatge
      try {
        const fileName = `${Date.now()}_${imageFile.name}`;
        const arrayBuffer = await imageFile.arrayBuffer();
        const buffer = Buffer.from(arrayBuffer);

        const supabase = createSupabase();
        const { error: uploadError } = await supabase.storage
          .from("images")
          .upload(fileName, buffer, {
            contentType: imageFile.type,
            upsert: false,
          });

        if (!uploadError) {
          const { data: publicData } = supabase.storage
            .from("images")
            .getPublicUrl(fileName);

          newData.image = publicData.publicUrl;
        } else {
          newData.image = item.image;
        }
      } catch {
        newData.image = item.image;
      }
    } else {
      newData.image = item.image;
    }

    // üîß 3Ô∏è‚É£ Actualitzar el registre
    const supabase = createSupabase();
    await supabase.from(table).update(newData).eq("id", id);
    return Astro.redirect(`/admin/${table}`);
  } catch {
    return Astro.redirect(`/admin/${table}`);
  }
}
---

<LayoutAdmin title={`Edit ${table}`}>
  <section class="flex flex-col items-center justify-center mt-12">
    <div class="text-center space-y-4">
      <h1 class="text-2xl md:text-4xl font-bold uppercase">Edit {table}</h1>
    </div>
  </section>

  <div class="flex flex-col items-center justify-center mt-12">
    <form
      method="post"
      enctype="multipart/form-data"
      novalidate
      class="flex flex-col gap-2 rounded-2xl p-10 space-y-2
          [&>input]:bg-web-pearl-blue [&>input]:p-2 [&>input]:rounded-lg
          [&>textarea]:bg-web-pearl-blue [&>textarea]:p-2 [&>textarea]:rounded-lg"
    >
      {
        tableFields?.map((field) => (
          <>
            <label for={field.name}>{field.name}</label>

            {field.type === "textarea" ? (
              <textarea
                name={field.name}
                id={field.name}
                required={field.name !== "image" && field.name !== "link"}
                class="bg-web-pearl-blue p-2 rounded-lg"
              >
                {item?.[field.name] || ""}
              </textarea>
            ) : field.type === "file" ? (
              <>
                {item?.[field.name] && (
                  <img
                    src={item[field.name]}
                    alt="Imatge actual"
                    class="w-48 rounded-lg mb-4"
                  />
                )}
                <input
                  type="file"
                  name={field.name}
                  id={field.name}
                  accept="image/*"
                  class="bg-web-pearl-blue p-2 rounded-lg"
                />
              </>
            ) : field.type === "select" ? (
              <select
                name={field.name}
                id={field.name}
                required={field.name !== "image" && field.name !== "link"}
                class="bg-web-pearl-blue p-2 rounded-lg"
              >
                {field.options?.map((option) => (
                  <option
                    value={option}
                    class="p-2"
                    selected={item?.[field.name] === option}
                  >
                    {option}
                  </option>
                ))}
              </select>
            ) : (
              <input
                type={field.type}
                name={field.name}
                id={field.name}
                value={item?.[field.name] || ""}
                required={field.name !== "link"}
                placeholder={
                  field.type === "url" ? "https://example.com" : undefined
                }
                class="bg-web-pearl-blue p-2 rounded-lg"
              />
            )}
          </>
        ))
      }

      <ButtonForm Text="Actualitza" />
    </form>
  </div>
</LayoutAdmin>
