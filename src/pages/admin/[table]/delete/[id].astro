---
import LayoutAdmin from "@/layouts/LayoutAdmin.astro"; // Layout general d'admin
import ButtonForm from "@/components/buttons/buttonForm.astro"; // BotÃ³ reutilitzable
import { createSupabase } from "@/lib/supabase"; // InstÃ ncia de Supabase

const { table, id } = Astro.params as { table: string; id: string };

// ğŸ”’ ComprovaciÃ³ dâ€™autenticaciÃ³
const accessToken = Astro.cookies.get("sb-access-token")?.value;
const refreshToken = Astro.cookies.get("sb-refresh-token")?.value;

// Si no hi ha tokens, redirigeix al login
if (!accessToken || !refreshToken) {
  return Astro.redirect("/admin");
}

try {
  // Intenta establir la sessiÃ³ amb Supabase
  const supabase = createSupabase();
  const { error } = await supabase.auth.setSession({
    access_token: accessToken,
    refresh_token: refreshToken,
  });
  if (error) {
    // Si hi ha error, elimina cookies i redirigeix
    Astro.cookies.delete("sb-access-token", { path: "/" });
    Astro.cookies.delete("sb-refresh-token", { path: "/" });
    return Astro.redirect("/admin");
  }
} catch {
  // En cas d'error inesperat, elimina cookies i redirigeix
  Astro.cookies.delete("sb-access-token", { path: "/" });
  Astro.cookies.delete("sb-refresh-token", { path: "/" });
  return Astro.redirect("/admin");
}

// ğŸ” Obtenir dades del registre a eliminar
let item = null;
try {
  const supabase = createSupabase();
  const { data, error } = await supabase
    .from(table)
    .select("*")
    .eq("id", id) // Filtra per id
    .single(); // NomÃ©s retorna un registre

  if (error || !data) {
    // Si no existeix l'entrada o hi ha error, redirigeix al llistat
    return Astro.redirect(`/admin/${table}`);
  }

  item = data; // Guarda l'entrada
} catch {
  return Astro.redirect(`/admin/${table}`);
}

// ğŸ—‘ï¸ GestiÃ³ del POST (confirmaciÃ³ d'eliminaciÃ³)
if (Astro.request.method === "POST") {
  try {
    const supabase = createSupabase();

    // ğŸ”‘ Autenticar el client amb la sessiÃ³ de l'usuari
    const { error: authError } = await supabase.auth.setSession({
      access_token: accessToken,
      refresh_token: refreshToken,
    });

    if (authError) {
      console.error("Auth error in POST:", authError);
      return Astro.redirect("/admin");
    }

    // ğŸ§¹ 1ï¸âƒ£ Eliminar la imatge del bucket si existeix
    if (item?.image) {
      try {
        const oldFileName = item.image.split("/").pop(); // Nom del fitxer
        if (oldFileName) {
          await supabase.storage.from("images").remove([oldFileName]);
        }
      } catch (err) {
        console.error("Error deleting image:", err);
      }
    }

    // ğŸ§¾ 2ï¸âƒ£ Eliminar el registre de la base de dades
    const { error: deleteError } = await supabase
      .from(table)
      .delete()
      .eq("id", id);

    if (deleteError) {
      console.error("Delete error:", deleteError);
      // Opcional: podrÃ­em redirigir amb un parÃ metre d'error
    }

    // ğŸ” 3ï¸âƒ£ Redirigir al llistat de la taula desprÃ©s dâ€™eliminar
    return Astro.redirect(`/admin/${table}`);
  } catch (err) {
    console.error("Unexpected error in POST:", err);
    return Astro.redirect(`/admin/${table}`);
  }
}
---

<!-- Layout i tÃ­tol de la pÃ gina dâ€™eliminaciÃ³ -->
<LayoutAdmin title={`Eliminar ${table}`}>
  <section
    class="flex flex-col items-center justify-center mt-12 text-center space-y-4"
  >
    <h1 class="text-2xl md:text-4xl font-bold uppercase">Eliminar {table}</h1>
    <p class="text-lg">
      Vols eliminar aquesta entrada? Aquesta acciÃ³ no es pot desfer.
    </p>
  </section>

  <!-- Caixa de confirmaciÃ³ amb informaciÃ³ del registre -->
  <div class="flex flex-col items-center justify-center mt-12">
    <div
      class="bg-web-dark-blue rounded-2xl p-10 space-y-6 max-w-md text-center"
    >
      <h2 class="text-xl font-semibold">{item?.title_ca || "Sense tÃ­tol"}</h2>

      {
        item?.image && (
          <img src={item.image} alt="Imatge" class="w-48 rounded-lg mx-auto" />
        )
      }

      <!-- Formulari de confirmaciÃ³ -->
      <form method="post" class="flex flex-col gap-4 mt-6">
        <!-- BotÃ³ per confirmar eliminaciÃ³ -->
        <ButtonForm Text="Confirmar eliminaciÃ³" />

        <!-- EnllaÃ§ per cancelÂ·lar i tornar al llistat -->
        <a
          href={`/admin/${table}`}
          class="text-web-pearl-blue underline hover:text-white"
        >
          CancelÂ·lar
        </a>
      </form>
    </div>
  </div>
</LayoutAdmin>
