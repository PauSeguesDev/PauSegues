---
import LayoutAdmin from "@/layouts/LayoutAdmin.astro";
import ButtonForm from "@/components/buttonForm.astro";
import { supabase } from "@/lib/supabase";

const { table } = Astro.params as { table: string };

// Comprovació d’autenticació amb cookies
const accessToken = Astro.cookies.get("sb-access-token")?.value;
const refreshToken = Astro.cookies.get("sb-refresh-token")?.value;

if (!accessToken || !refreshToken) {
  return Astro.redirect("/admin");
}

let session;
try {
  const { data, error } = await supabase.auth.setSession({
    access_token: accessToken,
    refresh_token: refreshToken,
  });

  if (error) {
    Astro.cookies.delete("sb-access-token", { path: "/" });
    Astro.cookies.delete("sb-refresh-token", { path: "/" });
    return Astro.redirect("/admin");
  }
  session = data.session;
} catch (err) {
  Astro.cookies.delete("sb-access-token", { path: "/" });
  Astro.cookies.delete("sb-refresh-token", { path: "/" });
  return Astro.redirect("/admin");
}

// Gestió del POST per crear nova entrada amb imatge
if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();
  const data = Object.fromEntries(formData.entries());

  // Obtenir el fitxer d'imatge
  const imageFile = formData.get("image") as File | null;

  if (imageFile && imageFile.size > 0) {
    const fileName = `${Date.now()}_${imageFile.name}`;

    try {
      // Convertir a Buffer per Node
      const arrayBuffer = await imageFile.arrayBuffer();
      const buffer = Buffer.from(arrayBuffer);

      // Puja la imatge a Supabase Storage
      const { data: uploadData, error: uploadError } = await supabase
        .storage
        .from("images")
        .upload(fileName, buffer, { contentType: imageFile.type, upsert: false });

      if (uploadError) throw uploadError;

      // Obtenir la URL pública de la imatge
      const { data: publicData } = supabase
        .storage
        .from("images")
        .getPublicUrl(fileName);

      data.image = publicData.publicUrl;

    } catch (err) {
      throw new Error("Error pujant la imatge");
    }
  }

  // Inserir les dades a la taula
  const { error: insertError } = await supabase.from(table).insert([data]);
  if (insertError) {
    throw new Error("Error inserint les dades");
  }

  // Redirigir al llistat de la taula
  return Astro.redirect(`/admin/${table}`);
}
---

<LayoutAdmin title={`New ${table}`}>
  <section class="flex flex-col items-center justify-center mt-12">
    <div class="text-center space-y-4">
      <h1 class="text-2xl md:text-4xl font-bold uppercase">New {table}</h1>
    </div>
  </section>

  <div class="flex flex-col items-center justify-center mt-12">
    <form method="post" enctype="multipart/form-data" novalidate
      class="flex flex-col gap-2 rounded-2xl p-10 space-y-2
             [&>input]:bg-web-pearl-blue [&>input]:p-2 [&>input]:rounded-lg
             [&>textarea]:bg-web-pearl-blue [&>textarea]:p-2 [&>textarea]:rounded-lg">

      <label for="title_ca">Títol (ca)</label>
      <input type="text" name="title_ca" id="title_ca" required />

      <label for="title_es">Títol (es)</label>
      <input type="text" name="title_es" id="title_es" required />

      <label for="title_en">Títol (en)</label>
      <input type="text" name="title_en" id="title_en" required />

      <label for="description_ca">Descripció (ca)</label>
      <textarea name="description_ca" id="description_ca" required></textarea>

      <label for="description_es">Descripció (es)</label>
      <textarea name="description_es" id="description_es" required></textarea>

      <label for="description_en">Descripció (en)</label>
      <textarea name="description_en" id="description_en" required></textarea>

      <label for="image">Imatge</label>
      <input type="file" name="image" id="image" accept="image/*" required />

      <ButtonForm Text="Guarda" />
    </form>
  </div>
</LayoutAdmin>
