---
import LayoutAdmin from "@/layouts/LayoutAdmin.astro";
import ButtonForm from "@/components/buttons/buttonForm.astro";
import { supabase } from "@/lib/supabase";

const { table } = Astro.params as { table: string };

// Comprovació d’autenticació amb cookies
const accessToken = Astro.cookies.get("sb-access-token")?.value;
const refreshToken = Astro.cookies.get("sb-refresh-token")?.value;

if (!accessToken || !refreshToken) {
  return Astro.redirect("/admin");
}

let session;
try {
  const { data, error } = await supabase.auth.setSession({
    access_token: accessToken,
    refresh_token: refreshToken,
  });

  if (error) {
    Astro.cookies.delete("sb-access-token", { path: "/" });
    Astro.cookies.delete("sb-refresh-token", { path: "/" });
    return Astro.redirect("/admin");
  }
  session = data.session;
} catch (err) {
  Astro.cookies.delete("sb-access-token", { path: "/" });
  Astro.cookies.delete("sb-refresh-token", { path: "/" });
  return Astro.redirect("/admin");
}

// Generació dinàmica de camps del formulari
import { dbTables } from "@/consts/dbTables";
const tableFields = dbTables.find((t) => t.name === table)?.fields;

// Gestió del POST per crear nova entrada amb imatge
if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();
  const data = Object.fromEntries(formData.entries());

  // Obtenir el fitxer d'imatge
  const imageFile = formData.get("image") as File | null;

  if (imageFile && imageFile.size > 0) {
    const fileName = `${Date.now()}_${imageFile.name}`;

    try {
      // Convertir a Buffer per Node
      const arrayBuffer = await imageFile.arrayBuffer();
      const buffer = Buffer.from(arrayBuffer);

      // Puja la imatge a Supabase Storage
      const { data: uploadData, error: uploadError } = await supabase
        .storage
        .from("images")
        .upload(fileName, buffer, { contentType: imageFile.type, upsert: false });

      if (uploadError) throw uploadError;

      // Obtenir la URL pública de la imatge
      const { data: publicData } = supabase
        .storage
        .from("images")
        .getPublicUrl(fileName);

      data.image = publicData.publicUrl;

    } catch (err) {
      throw new Error("Error pujant la imatge");
    }
  }

  // Inserir les dades a la taula
  const { error: insertError } = await supabase.from(table).insert([data]);
  if (insertError) {
    throw new Error("Error inserint les dades");
  }

  // Redirigir al llistat de la taula
  return Astro.redirect(`/admin/${table}`);
}
---

<LayoutAdmin title={`New ${table}`}>
  <section class="flex flex-col items-center justify-center mt-12">
    <div class="text-center space-y-4">
      <h1 class="text-2xl md:text-4xl font-bold uppercase">New {table}</h1>
    </div>
  </section>

  <div class="flex flex-col items-center justify-center mt-12">
    <form method="post" enctype="multipart/form-data" novalidate
      class="flex flex-col gap-2 rounded-2xl p-10 space-y-2
             [&>input]:bg-web-pearl-blue [&>input]:p-2 [&>input]:rounded-lg
             [&>textarea]:bg-web-pearl-blue [&>textarea]:p-2 [&>textarea]:rounded-lg">
      {tableFields?.map(field => (
        <>
          <label for={field.name}>{field.name}</label>
          {field.type === "textarea" ? (
            <textarea name={field.name} id={field.name} required></textarea>
          ) : (
            <input
              type={field.type === "file" ? "file" : field.type}
              name={field.name}
              id={field.name}
              required={field.name !== "link" && field.type !== "file"}
              placeholder={field.type === "url" ? "https://example.com" : ""}
              accept={field.type === "file" ? "image/*" : undefined}
            />
          )}
        </>
      ))}
      <ButtonForm Text="Guarda" />
    </form>
  </div>
</LayoutAdmin>
